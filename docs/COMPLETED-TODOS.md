### COMPLETED-TODO.md - The TO-DO list items that have been completed

LDD stands for Left for Developer/Designer to Decide. In other words, I don't care about this particular detail, so use your best engineering judgment to pick the best way and keep going.

1. [x] From this point forward, when Claude makes changes, it should run `git commit` with a descriptive commit message. Update CLAUDE.md accordingly.
2. [x] Sometimes `joke-pipeline.py --status` returns an error because it can't access a file (probably because it was moved). Make the script handle this properly.
3. [x] Make stage scripts check for the presence of the file `[project directory]/ALL_STOP` before starting work on the next file in it's stage queue. If that file exists, it should exit gracefully. When`joke-pipeline.py` is first started (before the main loop), it should check for that file and delete it if it exists. The name and path to `ALL_STOP` should set in `config.py`.
4. [x] When a script is operating on a file, the file remains in the stage directory. Prefer it was moved to the `[stage]/tmp/` directory so it won't get picked up by another script. (Preparation for multiple concurrent stage handlers.)
5. [x] When a script is operating on a file, make it write the joke ID to a status file (name LDD) in the stage directory. When it is done with that file it deletes the file, or just makes it empty (LDD). Change `joke-pipeline.py --status` to display main and prior pipelines in one column so there's more room to the right and display the ID from the status file next to the pipeline stage name and counts.
6. [x] When a script moves a joke to one of the reject stage directories, append the joke ID and the reason given (on one line) to a `logs/[main|pri]_reject_[stage]_failure.log` file. No need for a timestamp or other details. You can use the logging module, or another way (LDD)
7. [x] Deduplicate the categories in `docs/joke-categories.md` favoring categories containing ':'. Remove the trailing "Jokes" from the categories to better align with categories defined in `config.py`. Pull the VALID_CATEGORIES out of `config.py` and put them in a separate `joke-categories.py` file. Merge in the categories from `docs/joke-categories.md` into VALID_CATEGORIES. Make code, test and documentation changes to use VALID_CATEGORIES in `joke-categories.py`.
8. [x] We already bumped the max number of categories we allow from 3 to 10. Change the handling of categories: 1. if the AI gives you more than the max, ignore any that are not in VALID_CATEGORIES, then just take the first MAX_CATEGORIES_PER_JOKE from the front of the list and ignore the rest. Log a warning and list any suggested category not in VALID_CATEGORIES and any ignored categories.
9. [x] For all log messages, begin the message with {joke_id} so that the first part of the message is always the joke id. Example: `"f"Failed to parse JSON response for Joke-ID: {joke_id}"` -> `f"{joke_id} Failed to parse JSON response: {e}"`
10. [x] Getting a consistent response for the LLM spelling/grammar update doesn't seem to be possible with JSON. The AIs don't always output well formed JSON. I think they would do better with outputting a format similar to the joke format. One or more headers, a space, and then the content.
11. [x] Update calls to `joke-extractor/joke-extract.py` in `stage_incoming.py:process_file`: command line interface changed from arg1=<email_file>, arg2=<output_success_dir>, arg3=[<output_failure_dir>] to arg1=<output_success_dir>, arg2=<output_failure_dir>, arg3=<email_file>. Update docs and tests.
12. [x] Update requirement.txt (if needed) for all files in project.
13. [x] Reverse the requirement for `joke-extract.py` to delete ALL_STOP before starting. This should be deleted outside the project scripts (except for tests). Adjust test scripts to delete it before they start so it's presence won't make the tests fail. Update docs.
14. [x] Sometimes the LLM returns categories (LLM_CAT) that are not in the list (ALLOWED_CAT). Instead of rejecting the LLM_CAT outright, do the following checks in the order listed to see if a near-match can be found. Because it is a near-match, place any modified LLM_CAT at the end of the list so it will be removed if we end up with too many categories. This check should be performed before the max number of categories check. Update docs and tests.
    1. check if 'jokes' is at the end of LLM_CAT.lower(), and if so, remove it and see if it matches one of ALLOWED_CAT
    2. check if the LLM_CAT text is within (i.e. a substring of) one of ALLOWED_CAT; if so, replace the LLM_CAT with the identified ALLOWED_CAT
    3. check if the ALLOWED_CAT is a substring of LLM_CAT; if so, replace the LLM_CAT with the identified ALLOWED_CAT
    4. discard LLM_CAT as before
15. [x] Remove the confidence return value for the category stage. I've already commented out some code in `stage_formatted.py` marked with "### REMOVE CONFIDENCE START" and "### REMOVE CONFIDENCE END". Also `config.py:OLLAMA_CLEANLINESS_CHECK` has been updated. All the other places still need to be updated. Update docs and tests.
16. [x] I need a utility script (or add feature to `joke-pipeline.py`) to move one or more jokes from a reject stage to the appropriate non-reject stage so that it will be retried. I need to specify the pipeline (main or priority), the stage, and one or more joke-ids.
17. [x] The various stage names and pipeline directory names are inconsistent. Use these for the stage names: parse, dedup, clean_check, format, categorize, title. Use directory names that indicate what happens to files in the stage. e.g. 01_incoming -> 01_parse, 02_parsed -> 02_dedup, etc. Fix this throughout the code an docs. Rename all the main and priority stage directories. Make sure all the tests pass.
18. [x] The way the --retry mechanism works is too cumbersome. There are way too many options to type. Instead, if "--retry" is given, can we redefine the remaining command line arguments? For example: `joke-pipeline.py --retry <pipeline> <stage> <id1> <id2>`. Update docs and tests.
19. [x] I would like the full text of each reason to be included in a stage-based named header in the joke file. It's OK if the lines get very long. This will help with post-analysis. Do this for all stages where the LLM returns a reason. Update docs and tests.
20. [x] I want an additional indication that the title was LLM generated instead of provided by the submitter in a "Title-Source:" header in the joke file. Update docs and tests.
21. [x] I also want a stage-based named header indicating what LLM was used for that stage. Just use the info from OLLAMA_MODEL. Use "LLM-Model-Used:" for the header. Update docs and tests.
